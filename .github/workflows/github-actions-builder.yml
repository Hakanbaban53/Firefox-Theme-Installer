name: Github Actions Builder

on:
  push:
    tags:
      - "V[0-9]+.*" # Build for both Linux, Windows and macOS
      - "VW[0-9]+.*" # Build for Windows only
      - "VL[0-9]+.*" # Build for Linux only
      - "VM[0-9]+.*" # Build for macOS only

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Test if the tag is valid
        run: |
          if [[ ! ${{ github.ref }} =~ ^refs/tags/V[0-9]+\..* ]]; then
              echo "Invalid tag format. Please use the format Vx.x.x"
              exit 1
          fi

  build-linux:
    runs-on: ubuntu-latest
    needs: prepare
    if: startsWith(github.ref, 'refs/tags/VL') || startsWith(github.ref, 'refs/tags/V')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk
          pip install customtkinter pyinstaller pillow requests

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile ./main.py --name RealFire-Installer-Linux --hidden-import='PIL._tkinter_finder' --add-data="../RealFire-Installer/assets:assets" --add-data="../RealFire-Installer/language:language" --add-data="../RealFire-Installer/data/local:data/local" --hidden-import='PIL._tkinter_finder' --noconsole

      - name: Upload Linux executable
        uses: actions/upload-artifact@v3
        with:
          name: linux-executable
          path: dist/RealFire-Installer-Linux
      - name: Upload firefox icon
        uses: actions/upload-artifact@v3
        with:
          name: firefox.png
          path: assets/firefox.png

  package-to-appimage:
    runs-on: ubuntu-latest
    needs: build-linux
    if: startsWith(github.ref, 'refs/tags/VL') || startsWith(github.ref, 'refs/tags/V')
    steps:
      - name: Download Linux executable
        uses: actions/download-artifact@v3
        with:
          name: linux-executable

      - name: Download firefox icon
        uses: actions/download-artifact@v3
        with:
          name: firefox.png

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf libfuse2

      - name: Package into AppImage
        run: |
          mkdir -p RealFire-Installer.AppDir/usr/bin
          cp RealFire-Installer-Linux RealFire-Installer.AppDir/usr/bin/
          cp firefox.png RealFire-Installer.AppDir/

          cat << 'EOF' > RealFire-Installer.AppDir/AppRun
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          EXEC="${HERE}/usr/bin/start_app.sh"
          exec "${EXEC}"
          EOF

          chmod +x RealFire-Installer.AppDir/AppRun

          cat << 'EOF' > RealFire-Installer.AppDir/RealFire.desktop
          [Desktop Entry]
          Type=Application
          Name=RealFire Installer
          Exec=start_app.sh
          Icon=firefox
          Comment=RealFire Installer
          Categories=Utility;
          EOF

          chmod +x RealFire-Installer.AppDir/RealFire.desktop

          cat << 'EOF' > RealFire-Installer.AppDir/usr/bin/start_app.sh
          #!/bin/bash
          APPIMAGE_DIR=$(dirname "$(realpath "$0")")
          APP_EXECUTABLE="${APPIMAGE_DIR}/RealFire-Installer-Linux"
          if [ ! -f "$APP_EXECUTABLE" ]; then
              echo "Error: App executable not found: $APP_EXECUTABLE"
              exit 1
          fi
          env DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" "$APP_EXECUTABLE" "$@"
          EOF

          chmod +x RealFire-Installer.AppDir/usr/bin/start_app.sh

          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x ./appimagetool-x86_64.AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage RealFire-Installer.AppDir RealFire-Installer.AppImage
        shell: bash

      - name: Upload AppImage
        uses: actions/upload-artifact@v3
        with:
          name: Theme-Installer-Linux.AppImage
          path: RealFire-Installer.AppImage

  build-windows:
    runs-on: windows-latest
    needs: prepare
    if: startsWith(github.ref, 'refs/tags/VW') || startsWith(github.ref, 'refs/tags/V')
    steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Set up Python
          uses: actions/setup-python@v4
          with:
            python-version: "3.x"

        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install customtkinter tk pillow requests pyinstaller

        - name: Build with PyInstaller
          run: |
            pyinstaller --onefile .\main.py --name Theme-Installer-Windows --icon=../RealFire-Installer/assets/firefox.ico --add-data "..\RealFire-Installer\assets:assets" --add-data "..\RealFire-Installer\language:language" --add-data "..\RealFire-Installer\data\local:data\local" --noconsole

        - name: Create self-signed certificate
          run: |
            openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes -subj "/CN=RealFire"
            openssl pkcs12 -export -out cert.pfx -inkey key.pem -in cert.pem -passout pass:password

        - name: Install Windows SDK
          run: |
            choco install windows-sdk-10.0 --confirm
          shell: powershell

        - name: Sign the executable
          run: |
            $env:PATH += ";C:\Program Files (x86)\Windows Kits\10\bin\x64"
            signtool sign /f cert.pfx /p password /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 dist\Theme-Installer-Windows.exe
          shell: powershell

        - name: Upload signed executable
          uses: actions/upload-artifact@v3
          with:
            name: Theme-Installer-Windows.exe
            path: dist\Theme-Installer-Windows.exe


#   build-macos:
#     runs-on: macos-latest
#     needs: prepare
#     if: startsWith(github.ref, 'refs/tags/VM') || startsWith(github.ref, 'refs/tags/V')
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.x"

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install customtkinter tk pillow requests pyinstaller

#       - name: Build with PyInstaller
#         run: |
#           pyinstaller --onefile ./main.py --name RealFire-Installer-MacOS --hidden-import='PIL._tkinter_finder' --add-data="../RealFire-Installer/assets:assets" --add-data="../RealFire-Installer/language:language" --add-data="../RealFire-Installer/data/local:data/local" --noconsole

#       - name: Upload macOS executable
#         uses: actions/upload-artifact@v3
#         with:
#           name: theme-installer-macos
#           path: dist/RealFire-Installer-MacOS

#   package-to-dmg:
#     runs-on: macos-latest
#     needs: build-macos
#     if: startsWith(github.ref, 'refs/tags/VM') || startsWith(github.ref, 'refs/tags/V')
#     steps:
#       - name: Download macOS executable
#         uses: actions/download-artifact@v3
#         with:
#           name: theme-installer-macos

#       - name: Install dependencies
#         run: |
#           brew install create-dmg

#       - name: Package into DMG
#         run: |
#           create-dmg dist/RealFire-Installer-MacOS RealFire-Installer-MacOS.dmg
#         shell: bash

#       - name: Upload DMG
#         uses: actions/upload-artifact@v3
#         with:
#           name: RealFire-Installer-MacOS.dmg
#           path: RealFire-Installer-MacOS.dmg

  create-release:
    runs-on: ubuntu-latest
    needs: [
      build-linux,
      package-to-appimage,
      build-windows
    #   build-macos,
    #   package-to-dmg
    ]
    steps:
      - name: Download Linux AppImage
        uses: actions/download-artifact@v3
        with:
          name: Theme-Installer-Linux.AppImage

      - name: Download Windows Executable
        uses: actions/download-artifact@v3
        with:
          name: Theme-Installer-Windows.exe

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref }}
          body: |
            ## Changes in this release
            - Add a brief description of the changes or features included in this release.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux AppImage
        uses: softprops/action-gh-release@v1
        with:
          files: |
            RealFire-Installer-Linux.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows Executable
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Theme-Installer-Windows.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    #   - name: Upload macOS DMG
    #     uses: softprops/action-gh-release@v1
    #     with:
    #       tag: ${{ github.ref }}
    #       files: |
    #         RealFire-Installer-MacOS.dmg
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

